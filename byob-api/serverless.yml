service: okta-byob-api

frameworkVersion: ">=1.1.0 <2.0.0"

plugins:
  - serverless-offline-ssm
  - serverless-offline

custom:
  #env: ${file(./${self:provider.stage}.env.json)}
  region: ${opt:region, self:provider.region}
  stage: ${opt:stage, self:provider.stage}
  ssmPrefix: byob # This should match the prefix in the terraform script
  ssmParameters:
    OKTA_ISSUER: "/${self:custom.ssmPrefix}/okta/${self:custom.stage}/issuer-uri"
    OKTA_AUDIENCE: "/${self:custom.ssmPrefix}/okta/${self:custom.stage}/audience"
    OKTA_CLIENT_ID: "/${self:custom.ssmPrefix}/okta/${self:custom.stage}/client-id"
    OKTA_API_TOKEN: "/${self:custom.ssmPrefix}/okta/${self:custom.stage}/api-token"
    RECAPTCHA_SITE_SECRET: "/${self:custom.ssmPrefix}/okta/${self:custom.stage}/recaptcha-site-secret"

outputs:

provider:
  name: aws
  runtime: nodejs12.x
  profile: serverless-okta
  region: us-east-1
  stage: dev
  environment:
    # Set the SSM Parameter directly as an environment variable
    ISSUER: ${ssm:${self:custom.ssmParameters.OKTA_ISSUER}}
    AUDIENCE: ${ssm:${self:custom.ssmParameters.OKTA_AUDIENCE}}
    CLIENT_ID: ${ssm:${self:custom.ssmParameters.OKTA_CLIENT_ID}}
    #To-Do: Set SecureString parameter name in environment variable, not the actual value.
    API_KEY: ${ssm:${self:custom.ssmParameters.OKTA_API_TOKEN}~true}
    RECAPTCHA_SITE_SECRET: ${ssm:${self:custom.ssmParameters.RECAPTCHA_SITE_SECRET}~true}

  # To-Do: IAM Policy to Read SSM Parameters
  # iamRoleStatementsInherit: true
  # iamRoleStatements:
  #   - Effect: Allow
  #     Action:
  #       - ssm:GetParameters
  #     Resource: "arn:aws:ssm:#{AWS::Region}:#{AWS::AccountId}:parameter/${self:custom.ssmPrefix}/okta/${self:custom.stage}/*"

functions:
  oktaAuth:
    handler: authorizer/handler.auth
    cors: true

  register:
    handler: registration/register.handler
    events:
      - http:
          path: /register
          method: POST
          cors: true

  proxy:
    handler: proxy/okta.handler
    events:
      - http:
          path: / # this matches the base path
          method: ANY
      - http:
          path: /{any+} # this matches any path, the token 'any' doesn't mean anything special
          method: ANY

resources:
  Outputs:
    ApiUrl:
      Description: "The API Gateway URL"
      Value:
        Fn::Join:
          - ""
          - - "https://"
            - Ref: ApiGatewayRestApi
            - ".execute-api.${self:custom.region}.amazonaws.com/${self:custom.stage}"
